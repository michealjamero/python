<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MoodTune - Music for Every Emotion</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Additional styles can remain here if needed */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            text-align: center;
            background: linear-gradient(135deg,#1C1B4D, #B80E65, #179181);
            color: white;
        }

        header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 10px 0;
            z-index: 1000;
        }
        
        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        
        .logo {
            color: #fff;
            font-size: 1.8rem;
            font-weight: bold;
        }
        
        .logo span {
            color: #d466ff; 
        }
        
        nav ul {
            display: flex;
            gap: 20px;
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        nav ul li a {
            color: white;
            text-decoration: none;
            font-size: 1rem;
            padding: 10px;
            transition: 0.3s;
        }
        
        nav ul li a:hover {
            color: #4ecdc4;
        }

        .artist-profile {
            padding: 100px 24px 24px;
            background: linear-gradient(to bottom, rgba(83, 83, 83, 0.7), rgba(18, 18, 18, 0.7));
            text-align: left;
        }

        .artist-header {
            display: flex;
            align-items: center;
            gap: 24px;
            margin-bottom: 30px;
        }

        .artist-image {
            width: 232px;
            height: 232px;
            object-fit: cover;
            border-radius: 50%;
            box-shadow: 0 4px 60px rgba(0, 0, 0, 0.5);
        }

        .artist-info {
            flex: 1;
        }

        .artist-name {
            font-size: 6em;
            margin: 0;
            font-weight: bold;
            letter-spacing: -0.04em;
        }

        .monthly-listeners {
            color: #b3b3b3;
            margin: 10px 0;
            font-size: 0.95em;
        }

        .artist-actions {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-top: 24px;
        }

        .follow-button {
            background: transparent;
            color: white;
            border: 1px solid #727272;
            border-radius: 4px;
            padding: 8px 16px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .follow-button:hover {
            background: #d466ff; 
            color: white;
        }

        .more-button {
            color: #b3b3b3;
            background: transparent;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
        }
        .more-button:hover {
            background: #d466ff; 
            color: white;
        }

        .shuffle-button {
            background: #1ed760;
            color: black;
            border: none;
            border-radius: 50%;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: auto;
            font-size: 1.5em;
        }

        .popular-tracks {
            padding: 24px;
            text-align: left;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            margin: 20px;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        }

        .popular-tracks h2 {
            font-size: 1.5em;
            margin-bottom: 16px;
        }

        .track-list {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .track-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 8px;
            transition: background-color 0.3s, transform 0.2s;
            background-color: rgba(20, 20, 20, 0.5);
        }

        .track-item:hover {
            background-color: rgba(40, 40, 40, 0.7);
            transform: translateY(-3px);
        }
        
        

        .track-number {
            width: 24px;
            color: #b3b3b3;
            text-align: right;
            margin-right: 16px;
        }

        .track-image {
            width: 40px;
            height: 40px;
            margin-right: 16px;
            border-radius: 4px;
        }

        .track-info {
            flex: 1;
        }

        .track-title {
            font-weight: 400;
            margin-bottom: 4px;
        }

        .track-plays {
            color: #b3b3b3;
            font-size: 0.9em;
        }

        .verified-icon {
            color: #1ed760;
            margin-left: 8px;
            font-size: 1.2em;
        }

        .more-options {
            color: #b3b3b3;
            background: transparent;
            border: none;
            cursor: pointer;
            margin-left: 16px;
            font-size: 1.2em;
        }

        
        .mood-selection {
            padding: 40px 24px;
            background: rgba(24, 24, 24, 0.7);
            margin: 30px 20px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        }

        .mood-selection h2 {
            margin-bottom: 30px;
            font-size: 1.8em;
            text-align: left;
        }

        .mood-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .mood-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.3s;
        }
        
        .mood-item:hover {
            transform: translateY(-10px);
        }

        .hero-image {
            width: 180px;
            height: 180px;
            object-fit: cover;
            border-radius: 10px;
            margin-bottom: 16px;
            transition: transform 0.3s;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
        }

        .hero-image:hover {
            transform: scale(1.05);
        }

        .caption {
            font-size: 1em;
            font-weight: bold;
            border-radius: 500px;
            padding: 8px 24px;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
        }
        .Play {
            background: #d466ff; 
            color: white;
        }
        .anger {
            background: #ff3b30; 
            color: white;
        }

        .relaxed {
            background: gray; 
            color: white;
        }

        .happy {
            background: #ffcc00; 
            color: rgb(255, 255, 255);
        }

        .sad {
            background: #007aff; 
            color: white;
        }

        .love {
            background: #ff2d55; 
            color: white;
        }

        button {
            outline: none;
            cursor: pointer;
            border: none;
            padding: 0.9rem 2rem;
            margin: 0;
            font-family: inherit;
            font-size: inherit;
            position: relative;
            display: inline-block;
            letter-spacing: 0.05rem;
            font-weight: 700;
            font-size: 17px;
            border-radius: 500px;
            overflow: hidden;
            background: #d466ff;
            color: ghostwhite;
        }

        button span {
            position: relative;
            z-index: 10;
            transition: color 0.4s;
        }

        button:hover span {
            color: black;
        }

        button::before,
        button::after {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        button::before {
            content: "";
            background: #000;
            width: 120%;
            left: -10%;
            transform: skew(30deg);
            transition: transform 0.4s cubic-bezier(0.3, 1, 0.8, 1);
        }

        button:hover::before {
            transform: translate3d(100%, 0, 0);
        }
        
        .music-container {
            margin: 50px auto;
            max-width: 800px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }
        
        .music-container h2 {
            margin-bottom: 20px;
        }
        
        audio {
            width: 100%;
            margin-top: 10px;
            border-radius: 30px;
        }
        
        .footer {
            padding: 20px;
            background-color: rgba(0, 0, 0, 0.8);
            color: #ccc;
            margin-top: 5px;
        }
        
        .neon-text {
            color: #5f6df1;
            text-shadow: 0 0 5px #4a58db, 0 0 10px #604adb, 0 0 20px#894adb, 0 0 30px #a64adb, 0 0 40px #ff00ff, 0 0 50px #ff00ff, 0 0 75px #ff00ff;
        }
        /* üéµ TRENDING ANIMATIONS */
        .trend-up {
          color: #00ff88;
          animation: glowUp 1.2s ease-in-out;
          font-weight: bold;
        }

        .trend-down {
          color: #ff4d4d;
          animation: glowDown 1.2s ease-in-out;
          font-weight: bold;
        }

        .trend-same {
          color: #ccc;
        }

        .trend-new {
          color: #00bfff;
          font-weight: bold;
          animation: pulseNew 1.5s infinite;
        }

        @keyframes glowUp {
          0% { text-shadow: 0 0 0 #00ff88; }
          50% { text-shadow: 0 0 10px #00ff88, 0 0 20px #00ff88; }
          100% { text-shadow: 0 0 0 #00ff88; }
        }

        @keyframes glowDown {
          0% { text-shadow: 0 0 0 #ff4d4d; }
          50% { text-shadow: 0 0 10px #ff4d4d, 0 0 20px #ff4d4d; }
          100% { text-shadow: 0 0 0 #ff4d4d; }
        }

        @keyframes pulseNew {
          0%, 100% { opacity: 1; text-shadow: 0 0 5px #00bfff; }
          50% { opacity: 0.6; text-shadow: 0 0 15px #00bfff; }
        }
    </style>
</head>
<body>

    <!-- ‚úÖ Navigation Bar -->
    <header>
        <div class="nav-container">
            <div class="logo">Mood<span>Tune</span></div>
            <nav>
                <ul>
                    <li><a href="{{ url_for('home') }}">Home</a></li>
                    <li><a href="{{ url_for('library') }}">Library</a></li>
                    <li><a href="{{ url_for('about') }}">About</a></li>
                    <li><a href="{{ url_for('profile') }}">Profile</a></li>
                    {% if session.get('is_admin') %}
                    <li><a href="{{ url_for('admin') }}">Admin</a></li>
                    {% endif %}
                    {% if session.get('user_id') %}
                    <li><a href="{{ url_for('logout') }}">Logout</a></li>
                    {% else %}
                    <li><a href="{{ url_for('signin') }}">Sign-in</a></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </header>

    <!-- üåü Top 3 Artist Carousel (Interactive) --> 
    <section id="artist-spotlight" style=" 
        position: relative; 
        overflow: hidden; 
        border-radius: 12px; 
        margin: 60px 20px 30px; 
        padding: 40px 20px; 
        min-height: 300px; 
        text-align: left; 
        box-shadow: 0 0 30px rgba(200, 100, 255, 0.2); 
        transition: background 1s ease; 
      "> 
      <div id="artist-content" style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; position: relative; z-index: 3;"> 
          <div id="artist-info" style="flex: 1; min-width: 300px;"> 
              <h2 style="font-size: 1.4em; color: #b3b3b3;">üéµ Top Artists This Week</h2> 
              <h1 id="artist-name" style="font-size: 3em; margin: 10px 0; color: #fff;">Loading...</h1> 
              <p id="artist-stats" style="color: #ccc;">Fetching stats...</p> 
              <button id="play-top-track" style=" 
                  margin-top: 20px; 
                  background: #9b4de0; 
                  color: white; 
                  border: none; 
                  border-radius: 50px; 
                  padding: 12px 28px; 
                  cursor: pointer; 
                  font-weight: 600; 
                  transition: background 0.3s ease; 
              ">‚ñ∂ Play Top Song</button> 
          </div> 
  
          <div style="flex: 1; min-width: 280px; display: flex; justify-content: center;"> 
              <img id="artist-image" src="{{ url_for('static', filename='default_artist.png') }}" 
                   alt="Artist" style=" 
                      width: 240px; 
                      height: 240px; 
                      border-radius: 18px; 
                      object-fit: cover; 
                      box-shadow: 0 12px 28px rgba(0,0,0,0.2); 
                      transition: opacity 0.5s ease; 
              "> 
          </div> 
      </div> 
  
      <div id="artist-glow" style=" 
          position:absolute; 
          width:280px;height:280px; 
          border-radius:50%; 
          filter:blur(50px); 
          opacity:0.3; 
          z-index:1; 
          transition:background 1s ease; 
          top:50%; 
          left:50%; 
          transform:translate(-50%,-50%); 
          pointer-events:none; 
      "></div> 
      <!-- Navigation Arrows --> 
      <button id="prev-artist" class="button-62" style=" 
             position:absolute; top:20px; left:20px; 
         ">‚üµ</button> 
      <button id="next-artist" class="button-62" style=" 
             position:absolute; top:20px; right:20px; 
         ">‚ü∂</button> 
  
      <!-- Dots --> 
      <div style="position:absolute; bottom:20px; left:50%; transform:translateX(-50%); display:flex; gap:8px;"> 
          <div class="dot" style="width:10px;height:10px;border-radius:50%;background:#888;"></div> 
          <div class="dot" style="width:10px;height:10px;border-radius:50%;background:#444;"></div> 
          <div class="dot" style="width:10px;height:10px;border-radius:50%;background:#444;"></div> 
      </div> 
  
      <audio id="artist-audio" controls style="width:100%; margin-top:30px; border-radius:10px; display:none;"></audio> 
    </section> 
  
    <script> 
    let currentArtist = 0; 
    let artists = []; 
    let autoSlide; 
  
    async function loadTopArtists() { 
      try { 
        const response = await fetch('/api/top_artists'); 
        artists = await response.json(); 
        if (artists.length === 0) return; 
  
        displayArtist(0); 
        startAutoSlide(); 
      } catch (err) { 
        console.error('Error loading top artists:', err); 
      } 
    } 
  
    function displayArtist(index) { 
      const artist = artists[index]; 
      const name = document.getElementById('artist-name'); 
      const stats = document.getElementById('artist-stats'); 
      const img = document.getElementById('artist-image'); 
      const audio = document.getElementById('artist-audio'); 
      const playBtn = document.getElementById('play-top-track'); 
      const section = document.getElementById('artist-spotlight'); 
      const dots = document.querySelectorAll('.dot'); 
  
      const moodColors = { 
        'Happy': 'linear-gradient(135deg, #ffcc00, #ff6699)', 
        'Sad': 'linear-gradient(135deg, #3a4eff, #6fc3ff)', 
        'Anger': 'linear-gradient(135deg, #ff2b2b, #7a0000)', 
        'Chill': 'linear-gradient(135deg, #00ffaa, #008080)', 
        'Love': 'linear-gradient(135deg, #ff66cc, #ff3366)', 
        'Unknown': 'linear-gradient(135deg, #444, #777)' 
      }; 
  
      section.style.background = moodColors[artist.mood] || moodColors['Unknown']; 
      img.style.opacity = 0; 
      setTimeout(() => { 
        name.textContent = artist.name; 
        img.src = `/static/${artist.image}`; 
        stats.textContent = `üéß ${artist.listeners} listeners ‚Ä¢ üíø ${artist.top_song} (${artist.plays} plays) ‚Ä¢ Mood: ${artist.mood}`; 
        img.style.opacity = 1; 
      }, 300); 
  
      playBtn.onclick = () => { 
        if (!artist.audio_file) return; 
        audio.src = `/static/${artist.audio_file}`; 
        audio.style.display = 'block'; 
        audio.play(); 
        img.style.transform = 'scale(1.05)'; 
        img.style.boxShadow = '0 0 50px rgba(255,255,255,0.5)'; 
      }; 
  
      dots.forEach((dot, i) => dot.style.background = i === index ? '#9b4de0' : '#444'); 
      currentArtist = index; 
    } 
  
    function nextArtist() { 
      currentArtist = (currentArtist + 1) % artists.length; 
      displayArtist(currentArtist); 
    } 
    function prevArtist() { 
      currentArtist = (currentArtist - 1 + artists.length) % artists.length; 
      displayArtist(currentArtist); 
    } 
  
    function startAutoSlide() { 
      clearInterval(autoSlide); 
      autoSlide = setInterval(nextArtist, 7000); 
    } 
  
    document.getElementById('prev-artist').addEventListener('click', () => { 
      prevArtist(); 
      startAutoSlide(); 
    });

    document.getElementById('next-artist').addEventListener('click', () => { 
      nextArtist(); 
      startAutoSlide(); 
    });

    document.addEventListener('DOMContentLoaded', loadTopArtists);
    </script>



    <!-- ‚úÖ Mood Selection -->
    <section class="mood-selection">
        <h2>Choose Your Mood</h2>
        <div class="mood-container">
            <div class="mood-item">
                <img class="hero-image" src="{{ url_for('static', filename='cc91ed4ddd4a7394e91c8d1e76af308b.jpg') }}" alt="Happy Music">
                <button class="happy caption" onclick="window.location.href='{{ url_for('library') }}#happy-section'"><span>Happy</span></button>
            </div>
            <div class="mood-item">
                <img class="hero-image" src="{{ url_for('static', filename='de18fedc3a18ae111943cf36fdc8967a.jpg') }}" alt="Relaxing Music">
                <button class="relaxed caption" onclick="window.location.href='{{ url_for('library') }}#relaxed-section'"><span>Relaxed</span></button>


            </div>
            <div class="mood-item">
                <img class="hero-image" src="{{ url_for('static', filename='e63565dc2d6b82b162e3a17329614181.jpg') }}" alt="Love Music">
                <button class="love caption" onclick="window.location.href='{{ url_for('library') }}#love-section'"><span>Love</span></button>

            </div>
            <div class="mood-item">
                <img class="hero-image" src="{{ url_for('static', filename='1891b3fd114cdf8f93af4633958ed49c.jpg') }}" alt="Sad Music">
                <button class="sad caption" onclick="window.location.href='{{ url_for('library') }}#sad-section'"><span>Sad</span></button>
            </div>
            <div class="mood-item">
                <img class="hero-image" src="{{ url_for('static', filename='4000059775ba77e492ce3ae907e825cd.jpg') }}" alt="Anger Music">
                <button class="anger caption" onclick="window.location.href='{{ url_for('library') }}#anger-section'"><span>Anger</span></button>

            </div>
        </div>
    </section>

<!-- ‚úÖ Dynamic Popular Tracks -->
<section class="popular-tracks">
     <h2>üèÜ Top 15 Popular Tracks</h2>
     <div id="popular-list" class="track-list"></div>
 
     <!-- Player stays the same -->
     <div id="player-container" style="margin-top:20px; display:none;">
         <h3 id="now-playing" style="margin-bottom:10px;">Now Playing:</h3>
         <audio id="popular-player" controls style="width:100%; border-radius:10px;"></audio>
     </div>
 </section>

<script>
 async function recordPlay(songId) {
   try {
     await fetch('/api/track_play', {
       method: 'POST',
       headers: { 'Content-Type': 'application/json' },
       body: JSON.stringify({ song_id: songId })
     });
   } catch (err) {
     console.error('Error recording play:', err);
   }
 }

 function getTrendLabel(trend) {
   switch (trend) {
     case 'up': return `<span class="trend-up">üîº</span>`;
     case 'down': return `<span class="trend-down">üîΩ</span>`;
     case 'new': return `<span class="trend-new">üÜï</span>`;
     default: return `<span class="trend-same">‚è∫Ô∏è</span>`;
   }
 }

 function playTrack(file, title, artist, songId) {
   const player = document.getElementById('popular-player');
   const container = document.getElementById('player-container');
   const nowPlaying = document.getElementById('now-playing');

   player.src = file;
   nowPlaying.textContent = `Now Playing: ${artist} - ${title}`;
   container.style.display = 'block';
   player.play();
   container.scrollIntoView({ behavior: 'smooth', block: 'center' });

   recordPlay(songId);
 }

 async function loadPopular() {
   try {
     const response = await fetch('/api/popular');
     const tracks = await response.json();
     // Expose tracks globally for inline handlers
     window.popularTracks = tracks;
     const list = document.getElementById('popular-list');
     list.innerHTML = '';

     if (tracks.length === 0) {
       list.innerHTML = `<p style="color:#ccc;">No popular songs available right now.</p>`;
       return;
     }

     tracks.forEach((track, index) => {
       const moodClass = track.mood ? track.mood.toLowerCase() : 'neutral';
       const trendLabel = getTrendLabel(track.trend);

       const item = `
         <div class="music-player" style="display:flex;flex-direction:column;align-items:center;text-align:center;background:rgba(0,0,0,0.5);border-radius:8px;padding:10px;transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
           <img src="${encodeURI('/static/' + track.image)}" alt="${track.title}" style="width:220px;height:220px;object-fit:cover;border-radius:10px;" />
           <div style="margin-top:10px;">
             <div style="font-weight:600;">${track.artist} - ${track.title} ${trendLabel} <span style="margin-left:6px;color:#ccc;">#${track.rank}</span></div>
             <div style="color:#bbb;font-size:0.9rem;">Plays: ${track.play_count} ‚Ä¢ ${track.mood} ${track.duration ? '‚Ä¢ ' + track.duration : ''}</div>
           </div>
           <audio controls style="width:100%;margin-top:10px;border-radius:10px;" onplay="handlePopularPlay(${index})"><source src="${encodeURI('/static/' + track.audio_file)}" type="audio/mpeg"></audio>
         </div>`;
       list.insertAdjacentHTML('beforeend', item);
     });
   } catch (err) {
     console.error('Error loading popular songs:', err);
   }
 }

 async function handlePopularPlay(i) {
    try {
      const t = (window.popularTracks || [])[i];
      if (!t) return;
      // Record the play in play_history
      recordPlay(t.id);
    } catch (err) {
      console.error('Error handling popular play:', err);
    }
  }

document.addEventListener('DOMContentLoaded', loadPopular);
setInterval(loadPopular, 60000);
</script>

    <!-- Insert recently played section here -->
    <section id="recently-played-section" style="padding:28px;margin:20px;border-radius:10px;background:rgba(0,0,0,0.5);">
      <h2 style="margin-bottom:12px;">‚è±Ô∏è Recently Played</h2>
      <div id="recently-played-grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;max-height:70vh;overflow-y:auto;padding-right:6px;"></div>
    </section>

    <script>
    (function () {
      const grid = document.getElementById('recently-played-grid');

      async function fetchRecentlyPlayed() {
        try {
          const res = await fetch('/api/recently_played', { cache: 'no-store' });
          if (!res.ok) return;
          const data = await res.json();
          renderGrid(data || []);
        } catch (err) {
          console.error('Failed to fetch recently played:', err);
        }
      }

      function renderGrid(items) {
        if (!grid) return;
        grid.innerHTML = '';
        if (!items.length) {
          grid.innerHTML = `<div style="color:#ccc; grid-column:1/-1;">No recently played songs yet.</div>`;
          return;
        }

        items.forEach(item => {
          const image = item.image ? (`/static/${item.image}`) : '/static/defultimage.jpg';
          const audioSrc = item.audio_file ? `/static/${item.audio_file}` : '';
          const title = item.title || 'Unknown';
          const artist = item.artist || 'Unknown';
          const mood = item.mood || '';
          const playedAt = item.played_at ? new Date(item.played_at).toLocaleString() : '';

          const card = document.createElement('div');
          card.className = 'music-player';
          card.style = "display:flex;flex-direction:column;padding:10px;background:rgba(0,0,0,0.5);border-radius:8px;transition:transform 0.2s;";
          card.setAttribute('onmouseover', "this.style.transform='scale(1.02)'");
          card.setAttribute('onmouseout', "this.style.transform='scale(1)'");
          card.innerHTML = `
            <img src="${image}" alt="Album Cover" style="border-radius:5px;width:50%;margin:auto;margin-bottom:10px;">
            <div style="text-align:left;">
                <h3 style="font-size:14px;color:white;margin:0;">${artist} - ${title}</h3>
                <p style="font-size:12px;color:#b3b3b3;margin:2px 0 5px;">${mood || ''}${playedAt ? ' ‚Ä¢ ' + playedAt : ''}</p>
                ${ audioSrc ? `<audio controls style="width:100%;height:30px;"><source src="${audioSrc}" type="audio/mpeg"></audio>` : ''}
            </div>
          `;
          grid.appendChild(card);
        });

        // attach play listeners so plays inside the recently grid also record (if audio exists)
        grid.querySelectorAll('audio').forEach(a => {
          a.removeEventListener('play', onLocalPlay);
          a.addEventListener('play', onLocalPlay);
        });
      }

      // When one of these audio tags is played, call /play_song to update timestamp and broadcast update
      async function onLocalPlay(e) {
        const a = e.currentTarget;
        const card = a.closest('.music-player');
        if (!card) return;

        const img = card.querySelector('img');
        const metaTitle = card.querySelector('h3')?.innerText || '';
        // parse artist and title from string "Artist - Title"
        let artist = 'Unknown', title = metaTitle;
        if (metaTitle.includes('-')) {
          const parts = metaTitle.split('-').map(s => s.trim());
          artist = parts[0] || artist;
          title = parts[1] || title;
        }

        const audioSrc = a.querySelector('source')?.getAttribute('src') || '';
        const audioFile = audioSrc.split('/').pop() || '';
        const albumCover = img ? (img.getAttribute('src').split('/').pop() || '') : '';

        try {
          const resp = await fetch('/play_song', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              title: title,
              artist: artist,
              image: albumCover,
              audio_file: audioFile,
              mood: ''
            })
          });
          if (resp.ok) {
            // broadcast to other tabs
            try { new BroadcastChannel('mood-events').postMessage({ type: 'song_played', t: Date.now() }); } catch (e) {}
            try { localStorage.setItem('mood_song_played', String(Date.now())); } catch(e) {}
            // refresh this grid (move the song to top)
            fetchRecentlyPlayed();
          }
        } catch (err) {
          console.error('Error logging local play', err);
        }
      }

      // Setup inter-tab listeners so home/profile update immediately when a play occurs elsewhere
      try {
        const ch = new BroadcastChannel('mood-events');
        ch.onmessage = (e) => {
          if (e && e.data && e.data.type === 'song_played') fetchRecentlyPlayed();
        };
      } catch (err) { /* BroadcastChannel not supported */ }

      window.addEventListener('storage', (e) => {
        if (e.key === 'mood_song_played') fetchRecentlyPlayed();
      });

      // initial load + periodic refresh
      fetchRecentlyPlayed();
      setInterval(fetchRecentlyPlayed, 60_000); // every 60s
    })();
    </script>

    


    <!-- ‚úÖ About Section -->
    <section class="about-section" style="padding: 40px 24px; background: rgba(24, 24, 24, 0.7); margin: 30px 20px; border-radius: 10px; box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);">
        <h2 style="margin-bottom: 30px; font-size: 1.8em; text-align: left;">About MoodTune</h2>
        <div style="display: flex; flex-wrap: wrap; gap: 30px; align-items: center;">
            <div style="flex: 1; min-width: 300px; text-align: left;">
                <p>MoodTune is your personal music companion that adapts to your emotions.</p>
                <p>Our advanced algorithm analyzes your listening habits and mood preferences to create a tailored music experience.</p>
                <a href="{{ url_for('about') }}"><button class="cta-button" style="margin-top: 30px;"><span>Learn More</span></button></a>
            </div>
            <div style="flex: 1; min-width: 300px;">
                <img src="{{ url_for('static', filename='cc91ed4ddd4a7394e91c8d1e76af308b.jpg') }}" alt="About MoodTune" style="width: 100%; max-width: 400px; border-radius: 10px;">
            </div>
        </div>
    </section>

    <!-- ‚úÖ Newsletter -->
    <section class="newsletter" style="padding: 40px 24px; background: rgba(24, 24, 24, 0.7); margin: 30px 20px; border-radius: 10px;">
        <h2 style="margin-bottom: 20px; font-size: 1.8em;">Stay Updated</h2>
        <p style="margin-bottom: 30px;">Subscribe to our newsletter for the latest music recommendations and features.</p>
        <div style="display: flex; max-width: 500px; margin: 0 auto; gap: 10px;">
            <a href="{{ url_for('signin') }}" style="text-decoration: none; width: 100%;">
                <button style="width: 100%; margin-top: 10px; background: #d466ff; color: white; font-weight: bold;"><span>Subscribe</span></button>
            </a>
        </div>
    </section>

    <!-- ‚úÖ Footer -->
    <footer class="footer">
        <div style="display: flex; flex-wrap: wrap; justify-content: space-between; max-width: 1200px; margin: 0 auto; padding: 20px;">
            <div style="flex: 1; min-width: 200px; text-align: left; margin-bottom: 20px;">
                <h3 class="logo" style="margin-bottom: 15px;">Mood<span>Tune</span></h3>
                <p>Music for every emotion</p>
                <div style="display: flex; gap: 15px; margin-top: 20px;">
                    <a href="#" style="color: white; font-size: 1.2em;">üì±</a>
                    <a href="#" style="color: white; font-size: 1.2em;">üìò</a>
                    <a href="#" style="color: white; font-size: 1.2em;">üì∏</a>
                    <a href="#" style="color: white; font-size: 1.2em;">üê¶</a>
                </div>
            </div>
            <div style="flex: 1; min-width: 200px; text-align: left; margin-bottom: 20px;">
                <h3 style="margin-bottom: 15px;">Company</h3>
                <ul style="list-style: none; padding: 0;">
                    <li style="margin-bottom: 10px;"><a href="#" style="color: #b3b3b3; text-decoration: none;">About</a></li>
                    <li style="margin-bottom: 10px;"><a href="#" style="color: #b3b3b3; text-decoration: none;">Jobs</a></li>
                    <li style="margin-bottom: 10px;"><a href="#" style="color: #b3b3b3; text-decoration: none;">For the Record</a></li>
                </ul>
            </div>
        </div>
    </footer>
</body>
